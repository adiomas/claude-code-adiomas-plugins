#!/usr/bin/env bash
# yaml-helper.sh - Centralized YAML operations with file locking and validation
# Part of autonomous-dev v4.0 security improvements
#
# Usage:
#   source scripts/lib/yaml-helper.sh
#   yaml_write ".claude/state.yaml" "phase" "EXECUTE"
#   value=$(yaml_read ".claude/state.yaml" "phase")

set -euo pipefail

# Configuration
YAML_LOCK_TIMEOUT="${YAML_LOCK_TIMEOUT:-10}"
YAML_BACKUP_ON_WRITE="${YAML_BACKUP_ON_WRITE:-true}"

# Colors for output (if terminal)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    YELLOW='\033[0;33m'
    NC='\033[0m'
else
    RED=''
    YELLOW=''
    NC=''
fi

# Check if yq is available
_yaml_check_yq() {
    if ! command -v yq &> /dev/null; then
        echo -e "${RED}ERROR: yq is required but not installed${NC}" >&2
        echo "Install with: brew install yq (macOS) or snap install yq (Linux)" >&2
        return 1
    fi
}

# Validate YAML file syntax
# Usage: yaml_validate "/path/to/file.yaml"
# Returns: 0 if valid, 1 if invalid
yaml_validate() {
    local file="$1"

    if [[ ! -f "$file" ]]; then
        echo -e "${YELLOW}WARN: File does not exist: $file${NC}" >&2
        return 1
    fi

    if ! yq '.' "$file" > /dev/null 2>&1; then
        echo -e "${RED}ERROR: Invalid YAML syntax in: $file${NC}" >&2
        return 1
    fi

    return 0
}

# Read a value from YAML file (no locking needed for reads)
# Usage: yaml_read "/path/to/file.yaml" "key.subkey"
# Returns: The value or empty string if not found
yaml_read() {
    local file="$1"
    local key="$2"
    local default="${3:-}"

    _yaml_check_yq || return 1

    if [[ ! -f "$file" ]]; then
        echo "$default"
        return 0
    fi

    local value
    value=$(yq -r ".$key // \"\"" "$file" 2>/dev/null) || {
        echo "$default"
        return 0
    }

    if [[ "$value" == "null" || -z "$value" ]]; then
        echo "$default"
    else
        echo "$value"
    fi
}

# Write a value to YAML file with file locking
# Usage: yaml_write "/path/to/file.yaml" "key.subkey" "value"
# Returns: 0 on success, 1 on failure
yaml_write() {
    local file="$1"
    local key="$2"
    local value="$3"
    local lockfile="${file}.lock"

    _yaml_check_yq || return 1

    # Ensure directory exists
    local dir
    dir=$(dirname "$file")
    mkdir -p "$dir" 2>/dev/null || true

    # Create empty YAML if file doesn't exist
    if [[ ! -f "$file" ]]; then
        echo "# Auto-generated by autonomous-dev" > "$file"
    fi

    # Acquire lock and write
    (
        # Try to acquire exclusive lock with timeout
        if ! flock -w "$YAML_LOCK_TIMEOUT" 200 2>/dev/null; then
            echo -e "${RED}ERROR: Could not acquire lock for $file (timeout: ${YAML_LOCK_TIMEOUT}s)${NC}" >&2
            return 1
        fi

        # Validate existing file before modifying
        if [[ -f "$file" ]] && [[ -s "$file" ]]; then
            if ! yaml_validate "$file"; then
                echo -e "${RED}ERROR: Cannot write to corrupted YAML file: $file${NC}" >&2
                return 1
            fi
        fi

        # Backup before write (optional)
        if [[ "$YAML_BACKUP_ON_WRITE" == "true" ]] && [[ -f "$file" ]]; then
            cp "$file" "${file}.bak" 2>/dev/null || true
        fi

        # Perform the write
        if ! yq -i ".$key = \"$value\"" "$file" 2>/dev/null; then
            echo -e "${RED}ERROR: Failed to write to $file${NC}" >&2
            # Restore from backup if available
            if [[ -f "${file}.bak" ]]; then
                mv "${file}.bak" "$file"
            fi
            return 1
        fi

        # Validate after write
        if ! yaml_validate "$file"; then
            echo -e "${RED}ERROR: Write corrupted YAML file: $file${NC}" >&2
            # Restore from backup
            if [[ -f "${file}.bak" ]]; then
                mv "${file}.bak" "$file"
                echo "Restored from backup" >&2
            fi
            return 1
        fi

        return 0
    ) 200>"$lockfile"
}

# Write a numeric value to YAML file
# Usage: yaml_write_number "/path/to/file.yaml" "key" 42
yaml_write_number() {
    local file="$1"
    local key="$2"
    local value="$3"
    local lockfile="${file}.lock"

    _yaml_check_yq || return 1

    mkdir -p "$(dirname "$file")" 2>/dev/null || true

    if [[ ! -f "$file" ]]; then
        echo "# Auto-generated by autonomous-dev" > "$file"
    fi

    (
        if ! flock -w "$YAML_LOCK_TIMEOUT" 200 2>/dev/null; then
            echo -e "${RED}ERROR: Could not acquire lock for $file${NC}" >&2
            return 1
        fi

        yq -i ".$key = $value" "$file" 2>/dev/null
    ) 200>"$lockfile"
}

# Write a boolean value to YAML file
# Usage: yaml_write_bool "/path/to/file.yaml" "key" true
yaml_write_bool() {
    local file="$1"
    local key="$2"
    local value="$3"
    local lockfile="${file}.lock"

    _yaml_check_yq || return 1

    mkdir -p "$(dirname "$file")" 2>/dev/null || true

    if [[ ! -f "$file" ]]; then
        echo "# Auto-generated by autonomous-dev" > "$file"
    fi

    (
        if ! flock -w "$YAML_LOCK_TIMEOUT" 200 2>/dev/null; then
            echo -e "${RED}ERROR: Could not acquire lock for $file${NC}" >&2
            return 1
        fi

        yq -i ".$key = $value" "$file" 2>/dev/null
    ) 200>"$lockfile"
}

# Append to an array in YAML file
# Usage: yaml_array_append "/path/to/file.yaml" "items" "new_item"
yaml_array_append() {
    local file="$1"
    local key="$2"
    local value="$3"
    local lockfile="${file}.lock"

    _yaml_check_yq || return 1

    mkdir -p "$(dirname "$file")" 2>/dev/null || true

    if [[ ! -f "$file" ]]; then
        echo "# Auto-generated by autonomous-dev" > "$file"
    fi

    (
        if ! flock -w "$YAML_LOCK_TIMEOUT" 200 2>/dev/null; then
            echo -e "${RED}ERROR: Could not acquire lock for $file${NC}" >&2
            return 1
        fi

        # Initialize array if it doesn't exist
        local current
        current=$(yq -r ".$key // \"null\"" "$file" 2>/dev/null)
        if [[ "$current" == "null" ]]; then
            yq -i ".$key = []" "$file" 2>/dev/null
        fi

        yq -i ".$key += [\"$value\"]" "$file" 2>/dev/null
    ) 200>"$lockfile"
}

# Delete a key from YAML file
# Usage: yaml_delete "/path/to/file.yaml" "key.subkey"
yaml_delete() {
    local file="$1"
    local key="$2"
    local lockfile="${file}.lock"

    _yaml_check_yq || return 1

    if [[ ! -f "$file" ]]; then
        return 0
    fi

    (
        if ! flock -w "$YAML_LOCK_TIMEOUT" 200 2>/dev/null; then
            echo -e "${RED}ERROR: Could not acquire lock for $file${NC}" >&2
            return 1
        fi

        yq -i "del(.$key)" "$file" 2>/dev/null
    ) 200>"$lockfile"
}

# Check if a key exists in YAML file
# Usage: yaml_has_key "/path/to/file.yaml" "key.subkey"
# Returns: 0 if exists, 1 if not
yaml_has_key() {
    local file="$1"
    local key="$2"

    if [[ ! -f "$file" ]]; then
        return 1
    fi

    local value
    value=$(yq -r ".$key // \"__NOTFOUND__\"" "$file" 2>/dev/null)

    [[ "$value" != "__NOTFOUND__" && "$value" != "null" ]]
}

# Merge another YAML file into target
# Usage: yaml_merge "/path/to/target.yaml" "/path/to/source.yaml"
yaml_merge() {
    local target="$1"
    local source="$2"
    local lockfile="${target}.lock"

    _yaml_check_yq || return 1

    if [[ ! -f "$source" ]]; then
        echo -e "${RED}ERROR: Source file does not exist: $source${NC}" >&2
        return 1
    fi

    mkdir -p "$(dirname "$target")" 2>/dev/null || true

    (
        if ! flock -w "$YAML_LOCK_TIMEOUT" 200 2>/dev/null; then
            echo -e "${RED}ERROR: Could not acquire lock for $target${NC}" >&2
            return 1
        fi

        if [[ ! -f "$target" ]]; then
            cp "$source" "$target"
        else
            yq -i ". *= load(\"$source\")" "$target" 2>/dev/null
        fi
    ) 200>"$lockfile"
}

# Get all keys at a path
# Usage: yaml_keys "/path/to/file.yaml" "parent.key"
yaml_keys() {
    local file="$1"
    local key="${2:-}"

    if [[ ! -f "$file" ]]; then
        return 0
    fi

    if [[ -z "$key" ]]; then
        yq -r 'keys | .[]' "$file" 2>/dev/null
    else
        yq -r ".$key | keys | .[]" "$file" 2>/dev/null
    fi
}

# Cleanup lock files (call periodically or on exit)
yaml_cleanup_locks() {
    local dir="${1:-.claude}"
    find "$dir" -name "*.lock" -type f -mmin +5 -delete 2>/dev/null || true
}
