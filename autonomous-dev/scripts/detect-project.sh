#!/bin/bash
set -euo pipefail

PROFILE_FILE=".claude/project-profile.yaml"

# Skip if not in a project directory (no common project files)
if [[ ! -f "package.json" ]] && [[ ! -f "pyproject.toml" ]] && [[ ! -f "go.mod" ]] && [[ ! -f "Cargo.toml" ]] && [[ ! -f "pom.xml" ]]; then
    exit 0
fi

# Skip if profile already exists and is recent (less than 1 day old)
if [[ -f "$PROFILE_FILE" ]]; then
    # Check if file is less than 1 day old
    if [[ $(find "$PROFILE_FILE" -mtime -1 2>/dev/null) ]]; then
        exit 0
    fi
fi

# Check for required tools
if ! command -v yq &>/dev/null; then
    echo "Note: yq not installed. Run 'brew install yq' for full autonomous-dev functionality." >&2
    exit 0
fi

if ! command -v jq &>/dev/null; then
    echo "Note: jq not installed. Run 'brew install jq' for full autonomous-dev functionality." >&2
    exit 0
fi

# Create .claude directory if needed
mkdir -p .claude

# Initialize profile
cat > "$PROFILE_FILE" << 'EOF'
# Auto-detected project profile
# Generated by autonomous-dev plugin
# Edit this file to customize behavior

project:
  name: ""
  type: ""

stack:
  language: ""
  framework: ""

database:
  provider: "none"
  orm: "none"
  mcp_available: false
  schema_source: ""

commands:
  test: ""
  lint: ""
  typecheck: ""
  build: ""
  dev: ""

verification:
  required: []
  optional: []

patterns:
  source: ""
  tests: ""
  components: ""
EOF

# Detect project name
PROJECT_NAME=$(basename "$(pwd)")
yq -i ".project.name = \"$PROJECT_NAME\"" "$PROFILE_FILE"

# Detect Node.js projects
if [[ -f "package.json" ]]; then
    yq -i '.stack.language = "typescript/javascript"' "$PROFILE_FILE"

    # Extract scripts
    TEST_CMD=$(jq -r '.scripts.test // ""' package.json 2>/dev/null || echo "")
    LINT_CMD=$(jq -r '.scripts.lint // ""' package.json 2>/dev/null || echo "")
    BUILD_CMD=$(jq -r '.scripts.build // ""' package.json 2>/dev/null || echo "")
    DEV_CMD=$(jq -r '.scripts.dev // ""' package.json 2>/dev/null || echo "")
    TYPECHECK_CMD=$(jq -r '.scripts.typecheck // .scripts["type-check"] // ""' package.json 2>/dev/null || echo "")

    # Detect package manager
    if [[ -f "pnpm-lock.yaml" ]]; then
        PKG_MGR="pnpm"
    elif [[ -f "yarn.lock" ]]; then
        PKG_MGR="yarn"
    elif [[ -f "bun.lockb" ]]; then
        PKG_MGR="bun"
    else
        PKG_MGR="npm"
    fi

    [[ -n "$TEST_CMD" ]] && yq -i ".commands.test = \"$PKG_MGR test\"" "$PROFILE_FILE"
    [[ -n "$LINT_CMD" ]] && yq -i ".commands.lint = \"$PKG_MGR run lint\"" "$PROFILE_FILE"
    [[ -n "$BUILD_CMD" ]] && yq -i ".commands.build = \"$PKG_MGR run build\"" "$PROFILE_FILE"
    [[ -n "$DEV_CMD" ]] && yq -i ".commands.dev = \"$PKG_MGR run dev\"" "$PROFILE_FILE"
    [[ -n "$TYPECHECK_CMD" ]] && yq -i ".commands.typecheck = \"$PKG_MGR run typecheck\"" "$PROFILE_FILE"

    # Detect framework
    if [[ -f "next.config.js" ]] || [[ -f "next.config.mjs" ]] || [[ -f "next.config.ts" ]]; then
        yq -i '.stack.framework = "next.js"' "$PROFILE_FILE"
        yq -i '.project.type = "fullstack"' "$PROFILE_FILE"
    elif [[ -f "vite.config.js" ]] || [[ -f "vite.config.ts" ]]; then
        yq -i '.stack.framework = "vite"' "$PROFILE_FILE"
        yq -i '.project.type = "frontend"' "$PROFILE_FILE"
    elif [[ -f "nuxt.config.ts" ]]; then
        yq -i '.stack.framework = "nuxt"' "$PROFILE_FILE"
        yq -i '.project.type = "fullstack"' "$PROFILE_FILE"
    elif [[ -f "astro.config.mjs" ]]; then
        yq -i '.stack.framework = "astro"' "$PROFILE_FILE"
        yq -i '.project.type = "frontend"' "$PROFILE_FILE"
    elif [[ -f "svelte.config.js" ]]; then
        yq -i '.stack.framework = "svelte"' "$PROFILE_FILE"
        yq -i '.project.type = "frontend"' "$PROFILE_FILE"
    fi
fi

# Detect Python projects
if [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]] || [[ -f "requirements.txt" ]]; then
    yq -i '.stack.language = "python"' "$PROFILE_FILE"

    if [[ -f "pyproject.toml" ]]; then
        # Check for common frameworks
        if grep -q "django" pyproject.toml 2>/dev/null; then
            yq -i '.stack.framework = "django"' "$PROFILE_FILE"
            yq -i '.project.type = "backend"' "$PROFILE_FILE"
            yq -i '.commands.test = "python manage.py test"' "$PROFILE_FILE"
            yq -i '.commands.dev = "python manage.py runserver"' "$PROFILE_FILE"
        elif grep -q "fastapi" pyproject.toml 2>/dev/null; then
            yq -i '.stack.framework = "fastapi"' "$PROFILE_FILE"
            yq -i '.project.type = "backend"' "$PROFILE_FILE"
            yq -i '.commands.test = "pytest"' "$PROFILE_FILE"
        elif grep -q "flask" pyproject.toml 2>/dev/null; then
            yq -i '.stack.framework = "flask"' "$PROFILE_FILE"
            yq -i '.project.type = "backend"' "$PROFILE_FILE"
            yq -i '.commands.test = "pytest"' "$PROFILE_FILE"
        fi

        # Check for pytest
        if grep -q "pytest" pyproject.toml 2>/dev/null; then
            yq -i '.commands.test = "pytest"' "$PROFILE_FILE"
        fi

        # Check for ruff
        if grep -q "ruff" pyproject.toml 2>/dev/null; then
            yq -i '.commands.lint = "ruff check ."' "$PROFILE_FILE"
        fi

        # Check for mypy
        if grep -q "mypy" pyproject.toml 2>/dev/null; then
            yq -i '.commands.typecheck = "mypy ."' "$PROFILE_FILE"
        fi
    fi
fi

# Detect Go projects
if [[ -f "go.mod" ]]; then
    yq -i '.stack.language = "go"' "$PROFILE_FILE"
    yq -i '.project.type = "backend"' "$PROFILE_FILE"
    yq -i '.commands.test = "go test ./..."' "$PROFILE_FILE"
    yq -i '.commands.build = "go build ./..."' "$PROFILE_FILE"

    # Check for golangci-lint
    if command -v golangci-lint &>/dev/null; then
        yq -i '.commands.lint = "golangci-lint run"' "$PROFILE_FILE"
    fi
fi

# Detect Rust projects
if [[ -f "Cargo.toml" ]]; then
    yq -i '.stack.language = "rust"' "$PROFILE_FILE"
    yq -i '.commands.test = "cargo test"' "$PROFILE_FILE"
    yq -i '.commands.build = "cargo build"' "$PROFILE_FILE"
    yq -i '.commands.lint = "cargo clippy"' "$PROFILE_FILE"
fi

# ============================================
# DATABASE PROVIDER DETECTION
# ============================================

DB_PROVIDER="none"
DB_ORM="none"
DB_SCHEMA_SOURCE=""

if [[ -f "package.json" ]]; then
    DEPS=$(cat package.json)

    # Detect Supabase (PRIORITY)
    if echo "$DEPS" | grep -q "@supabase/supabase-js\|@supabase/ssr"; then
        DB_PROVIDER="supabase"
        DB_SCHEMA_SOURCE="mcp"
    # Detect Firebase
    elif echo "$DEPS" | grep -q '"firebase"\|"firebase-admin"'; then
        DB_PROVIDER="firebase"
        DB_SCHEMA_SOURCE="manual"
    # Detect PlanetScale
    elif echo "$DEPS" | grep -q "@planetscale/database"; then
        DB_PROVIDER="planetscale"
    # Detect Neon
    elif echo "$DEPS" | grep -q "@neondatabase/serverless"; then
        DB_PROVIDER="neon"
    # Detect MongoDB
    elif echo "$DEPS" | grep -q '"mongodb"\|"mongoose"'; then
        DB_PROVIDER="mongodb"
        if echo "$DEPS" | grep -q '"mongoose"'; then
            DB_ORM="mongoose"
        fi
        DB_SCHEMA_SOURCE="manual"
    # Detect PostgreSQL direct
    elif echo "$DEPS" | grep -q '"pg"\|"postgres"\|"@vercel/postgres"'; then
        DB_PROVIDER="postgres"
    # Detect MySQL
    elif echo "$DEPS" | grep -q '"mysql2"\|"mysql"'; then
        DB_PROVIDER="mysql"
    # Detect SQLite
    elif echo "$DEPS" | grep -q '"better-sqlite3"\|"sql.js"'; then
        DB_PROVIDER="sqlite"
    fi

    # Detect ORM (can override provider detection)
    if echo "$DEPS" | grep -q "@prisma/client"; then
        DB_ORM="prisma"
        DB_SCHEMA_SOURCE="prisma/schema.prisma"
    elif echo "$DEPS" | grep -q "drizzle-orm"; then
        DB_ORM="drizzle"
        # Try to find drizzle schema
        if [[ -f "drizzle.config.ts" ]]; then
            DB_SCHEMA_SOURCE="drizzle/schema.ts"
        elif [[ -f "src/db/schema.ts" ]]; then
            DB_SCHEMA_SOURCE="src/db/schema.ts"
        fi
    elif echo "$DEPS" | grep -q '"typeorm"'; then
        DB_ORM="typeorm"
    elif echo "$DEPS" | grep -q '"kysely"'; then
        DB_ORM="kysely"
    fi
fi

# Detect Prisma directory
if [[ -d "prisma" ]] && [[ -f "prisma/schema.prisma" ]]; then
    DB_ORM="prisma"
    DB_SCHEMA_SOURCE="prisma/schema.prisma"
    # If no provider detected, check prisma schema for datasource
    if [[ "$DB_PROVIDER" == "none" ]]; then
        if grep -q 'provider.*=.*"postgresql"' prisma/schema.prisma 2>/dev/null; then
            DB_PROVIDER="postgres"
        elif grep -q 'provider.*=.*"mysql"' prisma/schema.prisma 2>/dev/null; then
            DB_PROVIDER="mysql"
        elif grep -q 'provider.*=.*"sqlite"' prisma/schema.prisma 2>/dev/null; then
            DB_PROVIDER="sqlite"
        fi
    fi
fi

# Detect Drizzle config
if [[ -f "drizzle.config.ts" ]] || [[ -f "drizzle.config.js" ]]; then
    DB_ORM="drizzle"
fi

# Check for Supabase config directory
if [[ -d "supabase" ]] && [[ -f "supabase/config.toml" ]]; then
    DB_PROVIDER="supabase"
    DB_SCHEMA_SOURCE="mcp"
fi

# Write database config
yq -i ".database.provider = \"$DB_PROVIDER\"" "$PROFILE_FILE"
yq -i ".database.orm = \"$DB_ORM\"" "$PROFILE_FILE"
[[ -n "$DB_SCHEMA_SOURCE" ]] && yq -i ".database.schema_source = \"$DB_SCHEMA_SOURCE\"" "$PROFILE_FILE"

# MCP availability check (Supabase is the priority)
if [[ "$DB_PROVIDER" == "supabase" ]]; then
    yq -i '.database.mcp_available = true' "$PROFILE_FILE"
else
    yq -i '.database.mcp_available = false' "$PROFILE_FILE"
fi

# ============================================
# END DATABASE DETECTION
# ============================================

# Build verification lists
REQUIRED=()
OPTIONAL=()

TEST_CMD=$(yq -r '.commands.test' "$PROFILE_FILE" 2>/dev/null || echo "")
LINT_CMD=$(yq -r '.commands.lint' "$PROFILE_FILE" 2>/dev/null || echo "")
TYPECHECK_CMD=$(yq -r '.commands.typecheck' "$PROFILE_FILE" 2>/dev/null || echo "")
BUILD_CMD=$(yq -r '.commands.build' "$PROFILE_FILE" 2>/dev/null || echo "")

[[ -n "$TEST_CMD" && "$TEST_CMD" != "null" && "$TEST_CMD" != "" ]] && REQUIRED+=("test")
[[ -n "$LINT_CMD" && "$LINT_CMD" != "null" && "$LINT_CMD" != "" ]] && REQUIRED+=("lint")
[[ -n "$TYPECHECK_CMD" && "$TYPECHECK_CMD" != "null" && "$TYPECHECK_CMD" != "" ]] && REQUIRED+=("typecheck")
[[ -n "$BUILD_CMD" && "$BUILD_CMD" != "null" && "$BUILD_CMD" != "" ]] && OPTIONAL+=("build")

# Update verification arrays
if [[ ${#REQUIRED[@]} -gt 0 ]]; then
    REQUIRED_JSON=$(printf '"%s",' "${REQUIRED[@]}" | sed 's/,$//')
    yq -i ".verification.required = [$REQUIRED_JSON]" "$PROFILE_FILE"
fi
if [[ ${#OPTIONAL[@]} -gt 0 ]]; then
    OPTIONAL_JSON=$(printf '"%s",' "${OPTIONAL[@]}" | sed 's/,$//')
    yq -i ".verification.optional = [$OPTIONAL_JSON]" "$PROFILE_FILE"
fi

echo "Project profile created: $PROFILE_FILE"
